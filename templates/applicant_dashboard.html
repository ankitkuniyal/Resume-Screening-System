{% extends 'base.html' %}

{% block title %}{{ applicant_name }}'s Dashboard{% endblock %}
{% block styles %}
<link rel="stylesheet" href="../static/css/applicant_dashboard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Search and Filter Layout */
    .job-filters {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 30px;
        margin-bottom: 25px;
    }
    
    .search-container {
        flex: 2;
        min-width: 300px;
        max-width: 500px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 40px;
        box-sizing: border-box;
    }
    
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 14px;
    }

    /* Job Details Modal Styles */
    .job-details-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        z-index: 1000;
        overflow-y: auto;
        padding: 40px 20px;
    }
    
    .job-details-content {
        background-color: white;
        max-width: 900px;
        margin: 0 auto;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        padding: 30px;
        position: relative;
    }
    
    .close-modal {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        background: none;
        border: none;
        padding: 5px;
    }
    
    .close-modal:hover {
        color: #333;
    }
    
    .modal-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
        margin-bottom: 5px;
    }
    
    .modal-header .company-location {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .modal-header .job-meta {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    .modal-section {
        margin-bottom: 20px;
    }
    
    .modal-section h4 {
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .skills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .skill {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .skill.matched {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    .skill.missing {
        background-color: #ffebee;
        color: #c62828;
    }
    
    .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    @media (max-width: 768px) {
        .modal-body {
            grid-template-columns: 1fr;
        }
        
        .job-details-content {
            padding: 20px;
        }
    }

    /* Already Applied Button Styles */
    .btn-applied {
        background-color: #28a745;
        color: white;
        cursor: not-allowed;
    }
    
    .btn-applied:hover {
        background-color: #28a745;
        transform: none;
    }
</style>
{% endblock %}

{% block content %}
<header>
    <h1>Welcome, {{ applicant_name }}</h1>
    <nav>
        <ul>
            <li><a href="{{ url_for('applicant_dashboard') }}">Home</a></li>
            <li><a href="{{ url_for('applicant_profile') }}">Profile</a></li>
            <li><a href="#applied_jobs">Applied Jobs</a></li>
            <li><a href="{{ url_for('logout') }}" class="logout-btn">Logout</a></li>
        </ul>
    </nav>
</header>

<main>
    <section id="job-listings" class="job-listings-container">
        <div class="job-filters">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="job-search" class="search-input" placeholder="Search jobs by title, company, or location...">
            </div>
            
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="job-type-filter">Job Type:</label>
                    <select id="job-type-filter" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="Full-time">Full-time</option>
                        <option value="Part-time">Part-time</option>
                        <option value="Contract">Contract</option>
                        <option value="Internship">Internship</option>
                        <option value="Remote">Remote</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort-by">Sort By:</label>
                    <select id="sort-by" class="filter-select">
                        <option value="match">Best Match</option>
                        <option value="date">Newest</option>
                        <option value="salary">Salary</option>
                    </select>
                </div>
                
                <button id="reset-filters" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>
    
        <div class="job-grid">
            {% for job in job_postings %}
            <div class="job-card" data-job-id="{{ job.id }}" data-job-type="{{ job.job_type }}" 
                 data-match-score="{{ job.match_score }}" data-posted-date="{{ job.posted_date.timestamp() }}" 
                 data-salary="{{ job.salary if job.salary else 0 }}"
                 data-job-title="{{ job.job_title.lower() }}"
                 data-company="{{ job.company.lower() }}"
                 data-location="{{ job.location.lower() }}"
                 data-description="{{ job.description.lower() }}"
                 data-matched-skills="{{ job.matched_skills|join(',') }}"
                 data-required-skills="{{ job.required_skills|join(',') }}">
                <div class="job-card-header">
                    <h3>{{ job.job_title }}</h3>
                    <div class="company-location">
                        <span class="company">{{ job.company }}</span>
                        <span class="location">{{ job.location }}</span>
                    </div>
                </div>
                
                <div class="job-card-body">
                    <div class="job-meta">
                        <span class="salary">{{ job.salary if job.salary else 'Negotiable' }}</span>
                        <span class="job-type">{{ job.job_type }}</span>
                        <span class="date">{{ (now - job.posted_date).days }}d ago</span>
                    </div>
                    
                    <div class="match-info">
                        <div class="match-score">
                            <div class="score">{{ job.match_score }}%</div>
                            <div class="match-bar">
                                <div class="fill" style="width: {{ job.match_score }}%"></div>
                            </div>
                        </div>
                        <div class="skills-matched">
                            {{ job.matched_skills_count }}/{{ job.total_required_skills }} skills match
                        </div>
                    </div>
                    
                    <div class="preview-skills">
                        {% for skill in job.matched_skills[:3] %}
                        <span class="skill matched">{{ skill }}</span>
                        {% endfor %}
                        {% if (job.total_required_skills - job.matched_skills_count) > 0 %}
                        <span class="skill missing">+{{ job.total_required_skills - job.matched_skills_count }} more</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="job-card-footer">
                    {% if job.id in applied_job_ids %}
                    {% else %}
                    <form action="{{ url_for('apply_for_job', job_id=job.id) }}" method="POST" class="job-application-form">
                        <button type="submit" class="btn btn-apply">Quick Apply</button>
                    </form>
                    {% endif %}
                    <button class="btn btn-details" data-job-id="{{ job.id }}">
                        View Details <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="no-jobs">
                <i class="fas fa-briefcase"></i>
                <h3>No jobs found</h3>
                <p>Try adjusting your filters</p>
            </div>
            {% endfor %}
        </div>
    
        <div class="pagination">
            <button class="btn-prev"><i class="fas fa-chevron-left"></i></button>
            <div class="page-info">Page <span id="current-page">1</span></div>
            <button class="btn-next"><i class="fas fa-chevron-right"></i></button>
        </div>
    </section>

    <section id="applied_jobs">
        <h2>Jobs You Have Applied For</h2>
        <table>
            <thead>
                <tr>
                    <th>Job Title</th>
                    <th>Company</th>
                    <th>Location</th>
                    <th>Job Type</th>
                    <th>Applied On</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for applied_job in applied_jobs %}
                <tr>
                    <td>{{ applied_job.job.job_title }}</td>
                    <td>{{ applied_job.job.company }}</td>
                    <td>{{ applied_job.job.location }}</td>
                    <td>{{ applied_job.job.job_type }}</td>
                    <td>{{ applied_job.application_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ applied_job.status }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6">You have not applied to any jobs yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</main>

<!-- Job Details Modal -->
<div id="job-details-modal" class="job-details-modal">
    <div class="job-details-content">
        <button class="close-modal">&times;</button>
        <div class="modal-header">
            <h2 id="modal-job-title"></h2>
            <div class="company-location">
                <span class="company" id="modal-company"></span>
                <span class="location" id="modal-location"></span>
            </div>
            <div class="job-meta">
                <span class="salary" id="modal-salary"></span>
                <span class="job-type" id="modal-job-type"></span>
                <span class="date" id="modal-date"></span>
            </div>
            <div class="match-info">
                <div class="match-score">
                    <div class="score" id="modal-match-score"></div>
                    <div class="match-bar">
                        <div class="fill" id="modal-match-bar"></div>
                    </div>
                </div>
                <div class="skills-matched" id="modal-skills-matched"></div>
            </div>
        </div>
        
        <div class="modal-body">
            <div class="modal-section">
                <h4>Description</h4>
                <p id="modal-description"></p>
            </div>
            
            <div class="modal-section">
                <h4>Required Skills</h4>
                <div class="skills-list" id="modal-skills-list"></div>
            </div>
        </div>
        
        <div class="modal-actions">
            <form id="modal-application-form" method="POST" class="job-application-form">
                <button type="submit" class="btn btn-primary" id="modal-apply-btn">Apply Now</button>
            </form>
            <button class="btn btn-outline-secondary close-modal">Close</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Initialize variables
        let currentPage = 1;
        const jobsPerPage = 6;
        let allJobs = Array.from(document.querySelectorAll('.job-card'));
        let filteredJobs = [...allJobs];
        const modal = document.getElementById('job-details-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        
        // 2. Search functionality
        const jobSearch = document.getElementById('job-search');
        jobSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            filteredJobs = allJobs.filter(card => {
                if (searchTerm === '') return true;
                
                const jobTitle = card.dataset.jobTitle;
                const company = card.dataset.company;
                const location = card.dataset.location;
                const description = card.dataset.description;
                
                return jobTitle.includes(searchTerm) || 
                       company.includes(searchTerm) || 
                       location.includes(searchTerm) || 
                       description.includes(searchTerm);
            });
            
            currentPage = 1;
            updatePagination();
        });

        // 3. Prepare job data with proper numeric values
        allJobs.forEach(card => {
            // Extract elements
            const scoreEl = card.querySelector('.score');
            const dateEl = card.querySelector('.date');
            const salaryEl = card.querySelector('.salary');
            const jobTypeEl = card.querySelector('.job-type');
    
            // Convert match score (remove %)
            const matchScore = parseInt(scoreEl.textContent.replace('%', '')) || 0;
            
            // Convert date (handle "Xd ago" format)
            const daysAgo = parseInt(dateEl.textContent) || 0;
            const postedDate = new Date();
            postedDate.setDate(postedDate.getDate() - daysAgo);
            
            // Convert salary (handle "Negotiable" and parse numbers)
            let salary = 0;
            const salaryText = salaryEl.textContent;
            if (salaryText !== 'Negotiable') {
                salary = parseInt(salaryText.replace(/[^0-9]/g, '')) || 0;
            }
    
            // Store as data attributes
            card.dataset.jobType = jobTypeEl.textContent;
            card.dataset.matchScore = matchScore;
            card.dataset.postedDate = postedDate.getTime(); // timestamp
            card.dataset.salary = salary;
    
            // Add titles for debugging
            card.title = `Match: ${matchScore}% | Posted: ${postedDate.toDateString()} | Salary: ${salaryText}`;
        });
    
        // 4. Perfect Sorting Function (FIXED DIRECTION)
        function sortJobs(sortBy) {
            filteredJobs.sort((a, b) => {
                // Get numeric values for comparison
                let aValue, bValue;
    
                switch(sortBy) {
                    case 'match':  // Highest % first
                        aValue = parseFloat(a.dataset.matchScore);
                        bValue = parseFloat(b.dataset.matchScore);
                        return bValue - aValue;
                        
                    case 'date':   // Newest first
                        aValue = parseFloat(a.dataset.postedDate);
                        bValue = parseFloat(b.dataset.postedDate);
                        return bValue - aValue; // Newest dates have higher timestamps
                        
                    case 'salary': // Highest salary first, "Negotiable" last
                        aValue = parseFloat(a.dataset.salary);
                        bValue = parseFloat(b.dataset.salary);
                        if (aValue === 0) return 1;   // "Negotiable" goes to end
                        if (bValue === 0) return -1;  // Non-zero comes first
                        return bValue - aValue;       // Higher salaries first
                        
                    default:
                        return 0;
                }
            });
        }
    
        // 5. Filter jobs (updated to include search)
        function filterJobs() {
            const typeFilter = document.getElementById('job-type-filter').value;
            const sortBy = document.getElementById('sort-by').value;
            const searchTerm = jobSearch.value.toLowerCase().trim();
            
            filteredJobs = allJobs.filter(card => 
                (typeFilter === 'all' || card.dataset.jobType === typeFilter) &&
                (searchTerm === '' || 
                 card.dataset.jobTitle.includes(searchTerm) || 
                 card.dataset.company.includes(searchTerm) || 
                 card.dataset.location.includes(searchTerm) || 
                 card.dataset.description.includes(searchTerm))
            );
            
            sortJobs(sortBy);
            currentPage = 1;
            updatePagination();
        }
    
        // 6. Update pagination
        function updatePagination() {
            const start = (currentPage - 1) * jobsPerPage;
            const end = start + jobsPerPage;
            const totalPages = Math.ceil(filteredJobs.length / jobsPerPage) || 1;
            
            // Hide all jobs first
            allJobs.forEach(card => card.style.display = 'none');
            
            // Show jobs for current page
            filteredJobs.slice(start, end).forEach(card => card.style.display = 'block');
            
            // Update pagination controls
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            
            const prevBtn = document.querySelector('.btn-prev');
            const nextBtn = document.querySelector('.btn-next');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Show total pages if more than 1
            document.querySelector('.total-pages').style.display = 
                totalPages > 1 ? 'inline' : 'none';
            
            // Show/hide no jobs message
            document.querySelector('.no-jobs').style.display = 
                filteredJobs.length ? 'none' : 'block';
        }
    
        // 7. Change page with smooth scroll
        function changePage(delta) {
            const newPage = currentPage + delta;
            const totalPages = Math.ceil(filteredJobs.length / jobsPerPage);
            if (newPage < 1 || newPage > totalPages) return;
            
            currentPage = newPage;
            updatePagination();
            
            // Smooth scroll to top of job listings
            document.getElementById('job-listings').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    
        // 8. Job Application Handling
        function handleJobApplication(form, button) {
            const jobCard = form.closest('.job-card');
            const jobId = jobCard.dataset.jobId;
            
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the main card footer
                    const footer = jobCard.querySelector('.job-card-footer');
                    footer.innerHTML = `
                        <button class="btn btn-applied" disabled>
                            <i class="fas fa-check-circle"></i> Already Applied
                        </button>
                        <button class="btn btn-details" data-job-id="${jobId}">
                            View Details <i class="fas fa-chevron-right"></i>
                        </button>
                    `;
                    
                    // Update the modal if open for this job
                    if (modal.style.display === 'block' && document.getElementById('modal-application-form').action.includes(jobId)) {
                        document.getElementById('modal-application-form').innerHTML = `
                            <button class="btn btn-applied" disabled>
                                <i class="fas fa-check-circle"></i> Already Applied
                            </button>
                        `;
                    }
                    
                    // Reattach event listeners
                    footer.querySelector('.btn-details').addEventListener('click', showJobDetails);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // 9. Show job details in modal
        function showJobDetails() {
            const jobCard = this.closest('.job-card');
            const jobId = jobCard.dataset.jobId;
            
            // Populate modal with job data
            document.getElementById('modal-job-title').textContent = jobCard.querySelector('h3').textContent;
            document.getElementById('modal-company').textContent = jobCard.querySelector('.company').textContent;
            document.getElementById('modal-location').textContent = jobCard.querySelector('.location').textContent;
            document.getElementById('modal-salary').textContent = jobCard.querySelector('.salary').textContent;
            document.getElementById('modal-job-type').textContent = jobCard.querySelector('.job-type').textContent;
            document.getElementById('modal-date').textContent = jobCard.querySelector('.date').textContent;
            document.getElementById('modal-match-score').textContent = jobCard.querySelector('.score').textContent;
            document.getElementById('modal-match-bar').style.width = jobCard.querySelector('.fill').style.width;
            document.getElementById('modal-skills-matched').textContent = jobCard.querySelector('.skills-matched').textContent;
            document.getElementById('modal-description').textContent = jobCard.dataset.description;
            
            // Populate skills list
            const skillsList = document.getElementById('modal-skills-list');
            skillsList.innerHTML = '';
            
            const matchedSkills = jobCard.dataset.matchedSkills.split(',');
            const requiredSkills = jobCard.dataset.requiredSkills.split(',');
            
            requiredSkills.forEach(skill => {
                if (skill) {
                    const skillSpan = document.createElement('span');
                    skillSpan.className = matchedSkills.includes(skill) ? 'skill matched' : 'skill missing';
                    skillSpan.textContent = skill;
                    skillsList.appendChild(skillSpan);
                }
            });
            
            // Set up application form
            const applicationForm = document.getElementById('modal-application-form');
            applicationForm.action = `/apply/${jobId}`;
            
            if (jobCard.querySelector('.btn-applied')) {
                applicationForm.innerHTML = `
                    <button class="btn btn-applied" disabled>
                        <i class="fas fa-check-circle"></i> Already Applied
                    </button>
                `;
            } else {
                applicationForm.innerHTML = `
                    <button type="submit" class="btn btn-primary">Apply Now</button>
                `;
                applicationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleJobApplication(this, this.querySelector('button'));
                });
            }
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // 10. Close modal
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    
        // 11. Event listeners
        document.getElementById('job-type-filter').addEventListener('change', filterJobs);
        document.getElementById('sort-by').addEventListener('change', filterJobs);
        document.getElementById('reset-filters').addEventListener('click', () => {
            document.getElementById('job-type-filter').value = 'all';
            document.getElementById('sort-by').value = 'match';
            jobSearch.value = '';
            filterJobs();
        });
        
        document.querySelector('.btn-prev').addEventListener('click', () => changePage(-1));
        document.querySelector('.btn-next').addEventListener('click', () => changePage(1));
        
        // Keyboard navigation support
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                document.querySelector('.btn-prev').click();
            } else if (e.key === 'ArrowRight') {
                document.querySelector('.btn-next').click();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // Job application forms
        document.querySelectorAll('.job-application-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const button = this.querySelector('button[type="submit"]');
                handleJobApplication(this, button);
            });
        });
        
        // Details buttons
        document.querySelectorAll('.btn-details').forEach(btn => {
            btn.addEventListener('click', showJobDetails);
        });
        
        // Close modal buttons
        closeModalBtn.addEventListener('click', closeModal);
        document.querySelector('.modal-actions .close-modal').addEventListener('click', closeModal);
        
        // Close modal when clicking outside content
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    
        // 12. Initialize
        filterJobs();
    });
</script>
{% endblock %}